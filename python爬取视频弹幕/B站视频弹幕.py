#!/usr/bin/env python
# -*- coding: utf-8 -*-
import re
import time

import pandas as pd
import requests  # è¯·æ±‚ç½‘é¡µæ•°æ®
from tqdm import trange  # è·å–çˆ¬å–é€Ÿåº¦

"""æ•°æ®ç±»å‹
ï¿½ï¿½à³ƒï¿½ï¿½Dï¿½ï¿½
 (ï¿½ï¿½ï¿½5a44c194:58â€˜Cè¿˜æ˜¯85â€™Cï¼Ÿ@ï¿½ï¿½ï¿½b38701229663584261pï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½423afbdd:	é…¸æ¢…æ±¤@ï¿½ï¿½ï¿½ï¿½b38694783457165315pï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½73c69d3a:å—æ˜Œç†å·¥å­¦é™¢@ï¿½İ±ï¿½b38692226059468805pÎ‹ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½: (ï¿½ï¿½ï¿½4846ab8c:å“ˆå“ˆå“ˆå“ˆ@ï¿½×±ï¿½b38691848491368455pï¿½ï¿½ï¿½-
1688ä¸é¦™å—@ï¿½È±ï¿½b38690811250999299pÌ¨ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½b27a18e6:å‘Šè¾@Õ¦ï¿½ï¿½b38688557065830405pï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½Î¹ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½6ff7714c:	å˜¤å˜¤å˜¤@ï¿½ï¿½ï¿½ï¿½b38687196746088453pï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DÄ’/ (ï¿½ï¿½ï¿½937df54b:HèŒ¶é¢œè¯´ç™½å°±æ˜¯å¼€åˆ†åº—ï¼ŒèƒŒåè€æ¿æ˜¯ä¸€ä¸ªï¼Œå’ŒåŠ ç›Ÿä¸ä¸€æ ·@ï¿½ï¿½ï¿½ï¿½b38686057055125509pï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½6 (ï¿½ï¿½ï¿½2d3144aa:è¯´çš„å¤ªå¥½äº†@ï¿½ï¿½ï¿½ï¿½b38685522448089091pÛ¡ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½6 (ï¿½ï¿½ï¿½86fb42d5:'èœœé›ªå†°åŸæ‹‰ä¸€ä¸ªäººåŠ ç›Ÿï¼Œè¿”70%@ï¿½ï¿½ï¿½ï¿½b38685474008072195pï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½é¦…ï¿½Dï¿½ï¿½/ (ï¿½ï¿½ï¿½86fb42d5:Qèœœé›ªå†°åŸå°±æ˜¯è¿™ä¹ˆå¹²çš„ï¼Œç°åœ¨åˆæäº†ä¸€ä¸ªæ–°å“ç‰Œï¼Œâ€œèŒ¶å°å’–â€@ï¿½ï¿½ï¿½ï¿½b38685399331110917pï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½' (ï¿½ï¿½ï¿½98dea343:å¤ªçœŸå®äº†@ï¿½ï¿½ï¿½b38684171157110791pï¿½ï¿½`
 (ï¿½ï¿½ï¿½98dea343:åˆ«éª‚äº†åˆ«éª‚äº†@ï¿½ï¿½ï¿½b38683931173715971pï¿½ï¿½`
 (ï¿½ï¿½ï¿½9b2245c8:åˆ«éª‚äº†åˆ«éª‚äº†@ï¿½Ì°ï¿½b38682481037672455pÕ¯ï¿½
ï¿½ï¿½ï¿½ï¿½İ©ï¿½DÇŸ (ï¿½ï¿½ï¿½2f3a9d0f:å¤èŒ—å¥½å–ï¼@ï¿½È°ï¿½b38682252899516419pÜ³ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½  (ï¿½ï¿½ï¿½397218dc:;upä¸»æ˜¯ä¸ºäº†æµé‡å‘Šè¯‰ä½ ï¼Œå½“ç„¶ä¹Ÿä¼šæœ‰ä¸€äº›åŠ å·¥@ê¼°ï¿½b38681454830419971pï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½96019175:!æˆ‘ä¹Ÿè§‰å¾—èµ›ç™¾å‘³æŒºå¥½åƒçš„@İ°ï¿½ï¿½b38680642231205893pï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½6 (ï¿½ï¿½ï¿½244e2947:Zè¿™ä¸å°±æ˜¯ä¼ é”€å—ï¼Ÿä¸è¿‡æ¢äº†ä¸ªåå­—ï¼Œæ‘†åœ¨æ˜é¢ä¸Šäº†ï¼Œä¼ é”€çš„å‡çº§ç‰ˆæœ¬@ï¿½ï¿½ï¿½ï¿½b38680602849837059pß—ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½e39c7bb1:3å—é’±@ï¿½ï¿½ï¿½ï¿½b38680327296647171pï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DÖ­! (ï¿½ï¿½ï¿½c4f380b3:ä¸“ä¸šå›¢é˜Ÿ@ï¿½ï¿½ï¿½ï¿½b38680193565982725pÍŸï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½56db374b:çœŸå®ã€‚ã€‚ã€‚@ï¿½ï¿½ï¿½ï¿½b38679065858146307pŞšï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½21a95d47:	sopå˜¿å˜¿@ï¿½ï¿½ï¿½ï¿½b38679063747887109pï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ (ï¿½ï¿½ï¿½21a95d47:å¯¹çš„@ï¿½ï¿½ï¿½ï¿½b38678994262949895pï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DÎ± (ï¿½ï¿½ï¿½6535822d:å¸ˆå‚…åˆ«ç»ƒäº†@ï¿½ï¿½ï¿½ï¿½b38678068855832579pï¿½ï¿½ï¿½(
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½aac52c3e:å‚»äººæœ‰å‚»ç¦ï¼Œæ²™æ¯”æ²¡æœ‰@ï¿½ï¿½ï¿½b38676557763444739pï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½: (ï¿½ï¿½ï¿½3d02e17b:å–µå•Š@ï¿½ï¿½ï¿½b38675908077289477pÊ³9
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½ (ï¿½ï¿½ï¿½98a6bb6a:!æˆ‘å°±åƒä¸¤ä¸ªï¼Œå‰©ä¸‹éƒ½ç»™ä½ @ï¿½ï¿½ï¿½b38675279169716231pï¿½İ«ï¿½
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ (ï¿½ï¿½ï¿½7e269828:	å‰å®³äº†@ï¿½İ¯ï¿½b38675039256051717pï¿½ï¿½ï¿½ 
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DÔ† (ï¿½ï¿½ï¿½7fc308da:å¼€å½©ç¥¨åº—ä¸æ›´é¦™å˜›@ï¿½Ù¯ï¿½b38674781778739205pï¶†
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½ï¿½( (ï¿½ï¿½ï¿½c4e7cf01:å¼€è¶…å¸‚å§ï¼Œç¨³ç‚¹@ï¿½Ã¯ï¿½b38673291120476165pï¿½ï¿½ï¿½[
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Dï¿½/ (ï¿½ï¿½ï¿½9bd4b2e3:ä½†æ˜¯æ­¥è¡Œè¡—äººæµé‡å¤§@ï¿½ï¿½ï¿½ï¿½b38671210936532997pï¿½ï¿½Ü‡
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DÚ½- (ï¿½ï¿½ï¿½b562b432:'åˆšå‡†å¤‡å¼€   ç°åœ¨æƒ³æƒ³å¤ªå¹´è½»äº†@âš¯ï¿½b38670578963972099pï¿½Ñ†l
"""


def get_bilibili_url(start, end):
    url_list = []
    date_list = [i for i in pd.date_range(start, end).strftime('%Y-%m-%d')]
    for date in date_list:
        url = f"https://api.bilibili.com/x/v2/dm/web/history/seg.so?type=1&oid=141367679&date={date}"
        url_list.append(url)
    return url_list


def get_bilibili_danmu(url_list):
    headers = {
        "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36",
        "cookie": "ä½ è‡ªå·±çš„" # Headersä¸­copyå³å¯
    }

    with open("bilibili_danmu.txt", 'w', encoding='utf-8') as file:
        for i in trange(len(url_list)):
            url = url_list[i]
            response = requests.get(url, headers=headers)
            print(response.headers)
            response.encoding = 'utf-8'
            print(response.text)
            pattern = re.compile(r'.*:\s*(\S*)@')
            danmu = pattern.findall(response.text)
            danmu = [str(d) for d in danmu]
            print(danmu)
            for item in danmu:
                item = re.sub(
                    '[ï¿½\x01\x02\x03\\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x1b\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a]+',
                    '', item)
                file.write(item)
                file.write("\n")
            time.sleep(3)


if __name__ == "__main__":
    start = '9/24/2020'  # è®¾ç½®çˆ¬å–å¼¹å¹•çš„èµ·å§‹æ—¥
    end = '9/26/2020'  # è®¾ç½®çˆ¬å–å¼¹å¹•çš„ç»ˆæ­¢æ—¥
    url_list = get_bilibili_url(start, end)
    print(url_list)
    get_bilibili_danmu(url_list)
    print("å¼¹å¹•çˆ¬å–å®Œæˆ")
